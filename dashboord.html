<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ุฏุงุดุจูุฑุฏ | ูุงูุฑฺฉุดุช</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="output.css" rel="stylesheet">
<!-- ูููุช ุงุฑุงูโุณูุณ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css">
<style>
    body {
        font-family: 'Vazirmatn', sans-serif;
    }
    
    .error-message {
        background-color: #fee;
        border: 1px solid #f99;
        color: #c00;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        display: none;
    }
    
    .success-message {
        background-color: #efe;
        border: 1px solid #9f9;
        color: #090;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        display: none;
    }
</style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 flex flex-col min-h-screen">

<!-- ================= HEADER ================= -->
<header class="flex items-center justify-between px-4 py-3 bg-white dark:bg-gray-800 shadow">
    <div class="flex items-center gap-4">
        <button id="menuBtn" class="text-2xl">โฐ</button>
        <span class="text-lg font-bold">ุณุงูุงูู ูุงูุฑฺฉุดุช ุฏุงูุดุฌู</span>
    </div>
    <div class="flex items-center gap-4">
        <button id="themeToggle" class="text-xl">๐</button>
        <a href="#" id="logoutBtn" class="text-xl" title="ุฎุฑูุฌ">๐ค</a>
    </div>
</header>

<!-- ================= LAYOUT ================= -->
<div class="flex flex-1">

    <!-- ================= SIDEBAR ================= -->
<aside id="sidebar" class="w-72 min-h-screen bg-white dark:bg-gray-800 shadow-lg p-4 hidden">
    <nav class="space-y-3 text-sm">
        <a href="#" class="block font-bold hover:text-green-600">ุฏุงุดุจูุฑุฏ</a>

        <div>
            <button onclick="toggleSubmenu('baseData')" class="flex justify-between w-full hover:text-green-600">
                <span>ุฏุงุฏู ูุง ุงููู</span><span>โพ</span>
            </button>
            <div id="baseData" class="mr-4 mt-2 space-y-1 hidden text-gray-600 dark:text-gray-300">
                <a href="new_year.html" class="block hover:text-green-500">ุซุจุช ุณุงู ุฒุฑุงุน</a>
                <a href="new_province.html" class="block hover:text-green-500">ุซุจุช ุงุณุชุงู</a>
                <a href="new_city.html" class="block hover:text-green-500 font-bold">ุซุจุช ุดูุฑุณุชุงู</a>
                <a href="new_village.html" class="block hover:text-green-500">ุซุจุช ุฑูุณุชุง</a>
                <a href="new_car.html" class="block hover:text-green-500">ุซุจุช ุงููุงุน ุฎูุฏุฑู</a>
                <a href="new_driver.html" class="block hover:text-green-500">ุซุจุช ุฑุงููุฏู</a>
                <a href="new_factory.html" class="block hover:text-green-500">ุซุจุช ฺฉุงุฑุฎุงูู</a>
                <a href="new_unit.html" class="block hover:text-green-500">ุซุจุช ูุงุญุฏ ุงูุฏุงุฒู ฺฏุฑ</a>
                <a href="new_poison.html" class="block hover:text-green-500">ุซุจุช ุงููุงุน ุณู</a>
                <a href="new_seed.html" class="block hover:text-green-500">ุซุจุช ุงููุงุน ุจุฐุฑ</a>
                <a href="new_commodity.html" class="block hover:text-green-500">ุซุจุช ุงููุงุน ฺฉุงูุง</a>
                <a href="pay.html" class="block hover:text-green-500">ุซุจุช ุงููุงุน ูพุฑุฏุงุฎุช</a>
                <a href="price.html" class="block hover:text-green-500">ุซุจุช ููุช ฺฉุงูุง</a>
                <a href="cutie.html" class="block hover:text-green-500">ุซุจุช ููุช ุนุงุฑ</a>
                <a href="new_farmer.html" class="block hover:text-green-500">ุซุจุช ฺฉุดุงูุฑุฒ</a>
            </div>
        </div>

        <div>
            <button onclick="toggleSubmenu('contractorOps')" class="flex justify-between w-full hover:text-green-600">
                <span>ุนููุงุช ูพูุงูฺฉุงุฑ</span><span>โพ</span>
            </button>
            <div id="contractorOps" class="mr-4 mt-2 space-y-1 hidden">
                <a href="factory_pay.html" class="block hover:text-green-500">ุซุจุช ูุงุฑุฒ ฺฉุงุฑุฎุงูู</a>
                <a href="factory_seed.html" class="block hover:text-green-500">ุซุจุช ุจุฐุฑ ฺฉุงุฑุฎุงูู</a>
                <a href="factory_poison.html" class="block hover:text-green-500">ุซุจุช ุณู ฺฉุงุฑุฎุงูู</a>
                <a href="factory_sugar.html" class="block hover:text-green-500">ุซุจุช ุดฺฉุฑ ฺฉุงุฑุฎุงูู</a>
                <a href="factory_scum.html" class="block hover:text-green-500">ุซุจุช ุชูุงูู ฺฉุงุฑุฎุงูู</a>
            </div>
        </div>

        <a href="farmers_operations.html" class="block hover:text-green-600">ุนููุงุช ฺฉุดุงูุฑุฒ</a>
        <a href="#" class="block hover:text-green-600">ุตูุฑุชุญุณุงุจ ฺฉุดุงูุฑุฒุงู</a>

        <div>
            <button onclick="toggleSubmenu('reports')" class="flex justify-between w-full hover:text-green-600">
                <span>ฺฏุฒุงุฑุด ฺฏุฑ</span><span>โพ</span>
            </button>
            <div id="reports" class="mr-4 mt-2 space-y-1 hidden">
                <a href="#" class="block hover:text-green-500">ฺฏุฒุงุฑุด ฺฉู</a>
                <a href="#" class="block hover:text-green-500">ฺฏุฒุงุฑุด ฺฉุงุฑุฎุงูู ูุง</a>
                <a href="#" class="block hover:text-green-500">ฺฏุฒุงุฑุด ุจุฐุฑ</a>
                <a href="#" class="block hover:text-green-500">ฺฏุฒุงุฑุด ุณู</a>
                <a href="#" class="block hover:text-green-500">ฺฏุฒุงุฑุด ุดฺฉุฑ</a>
                <a href="#" class="block hover:text-green-500">ฺฏุฒุงุฑุด ุชูุงูู</a>
            </div>
        </div>

        <a href="#" class="block hover:text-green-600">ูุฏุฑุช ุงุฑุณุงู ูพุงูฺฉ</a>
        <a href="#" class="block hover:text-green-600">ุซุจุช ุจุงุฑ ูุง ุขูุงุฏู ุญูู</a>

        <div>
            <button onclick="toggleSubmenu('settings')" class="flex justify-between w-full hover:text-green-600">
                <span>ุชูุธูุงุช</span><span>โพ</span>
            </button>
            <div id="settings" class="mr-4 mt-2 space-y-1 hidden">
                <a href="#" class="block hover:text-green-500">ูุฏุฑุช ฺฉุงุฑุจุฑุงู</a>
                <a href="#" class="block hover:text-green-500">ุชุนู ุฑูุฒ ุนุจูุฑ</a>
                <a href="#" class="block hover:text-red-500">ุฎุฑูุฌ</a>
            </div>
        </div>

        <a href="#" class="block hover:text-green-600">ูพุดุชุจุงู</a>
    </nav>
</aside>


    <!-- ================= MAIN ================= -->
    <main class="flex-1 p-6">
        <!-- ูพุงูโูุง ูุถุนุช -->
        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>

<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-5">

<!-- card -->
<div class="group bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 
border border-gray-200 dark:border-gray-700 rounded-2xl p-5 
shadow-sm hover:shadow-xl hover:-translate-y-1 hover:scale-[1.02] 
transition-all duration-300 relative overflow-hidden">

<div class="absolute top-0 left-0 w-full h-1 bg-blue-500 opacity-70"></div>

<div class="text-sm text-gray-500 group-hover:text-gray-700 dark:group-hover:text-gray-300 mb-2 transition">
ูุงูุฏู ูุนู ุฏุฑ ุญุณุงุจ ูพูุงูฺฉุงุฑ
</div>
<div class="text-2xl font-extrabold text-gray-800 dark:text-white" id="contractorBalance">ฐ ุชููุงู</div>
</div>

<!-- ุชฺฉุฑุงุฑ ููู ุงุณุชุงู ุจุฑุง ุจูู -->
<div class="group bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 border border-gray-200 dark:border-gray-700 rounded-2xl p-5 shadow-sm hover:shadow-xl hover:-translate-y-1 hover:scale-[1.02] transition-all duration-300 relative overflow-hidden">
<div class="absolute top-0 left-0 w-full h-1 bg-purple-500 opacity-70"></div>
<div class="text-sm text-gray-500 mb-2">ุชุนุฏุงุฏ ูุฑุงุฑุฏุงุฏ ฺฉุดุงูุฑุฒุงู</div>
<div class="text-2xl font-extrabold dark:text-white" id="farmerContracts">ฐ ุนุฏุฏ</div>
</div>

<div class="group bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 border border-gray-200 dark:border-gray-700 rounded-2xl p-5 shadow-sm hover:shadow-xl hover:-translate-y-1 hover:scale-[1.02] transition-all duration-300 relative overflow-hidden">
<div class="absolute top-0 left-0 w-full h-1 bg-green-500 opacity-70"></div>
<div class="text-sm text-gray-500 mb-2">ฺฉู ุชูุงฺ ุชุญูู ฺฉุดุงูุฑุฒุงู</div>
<div class="text-2xl font-extrabold dark:text-white" id="totalTonnage">ฐ ุชู</div>
</div>

<div class="group bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 border border-gray-200 dark:border-gray-700 rounded-2xl p-5 shadow-sm hover:shadow-xl hover:-translate-y-1 hover:scale-[1.02] transition-all duration-300 relative overflow-hidden">
<div class="absolute top-0 left-0 w-full h-1 bg-red-500 opacity-70"></div>
<div class="text-sm text-gray-500 mb-2">ุฌูุน ุจุฏู ุจู ฺฉุดุงูุฑุฒุงู</div>
<div class="text-2xl font-extrabold dark:text-white" id="totalDebt">ฐ ุชููุงู</div>
</div>

<div class="group bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 border border-gray-200 dark:border-gray-700 rounded-2xl p-5 shadow-sm hover:shadow-xl hover:-translate-y-1 hover:scale-[1.02] transition-all duration-300 relative overflow-hidden">
<div class="absolute top-0 left-0 w-full h-1 bg-yellow-500 opacity-70"></div>
<div class="text-sm text-gray-500 mb-2">ุฌูุน ุทูุจ ุงุฒ ฺฉุดุงูุฑุฒุงู</div>
<div class="text-2xl font-extrabold dark:text-white" id="totalClaim">ฐ ุชููุงู</div>
</div>

<div class="group bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 border border-gray-200 dark:border-gray-700 rounded-2xl p-5 shadow-sm hover:shadow-xl hover:-translate-y-1 hover:scale-[1.02] transition-all duration-300 relative overflow-hidden">
<div class="absolute top-0 left-0 w-full h-1 bg-indigo-500 opacity-70"></div>
<div class="text-sm text-gray-500 mb-2">ูุงูุฏู ุชุง ุชุณูู ฺฉุดุงูุฑุฒุงู</div>
<div class="text-2xl font-extrabold dark:text-white" id="remainingToSettle">ฐ ุชููุงู</div>
</div>

<div class="group bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 border border-gray-200 dark:border-gray-700 rounded-2xl p-5 shadow-sm hover:shadow-xl hover:-translate-y-1 hover:scale-[1.02] transition-all duration-300 relative overflow-hidden">
<div class="absolute top-0 left-0 w-full h-1 bg-pink-500 opacity-70"></div>
<div class="text-sm text-gray-500 mb-2">ฺฉุงุฑูุฒุฏ ูพูุงูฺฉุงุฑ (ฑูช)</div>
<div class="text-2xl font-extrabold dark:text-white" id="contractorFee">ฐ ุชููุงู</div>
</div>

<div class="group bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 border border-gray-200 dark:border-gray-700 rounded-2xl p-5 shadow-sm hover:shadow-xl hover:-translate-y-1 hover:scale-[1.02] transition-all duration-300 relative overflow-hidden">
<div class="absolute top-0 left-0 w-full h-1 bg-emerald-500 opacity-70"></div>
<div class="text-sm text-gray-500 mb-2">ุณูุฏ ูพูุงูฺฉุงุฑ ุงุฒ ุจุฐุฑ</div>
<div class="text-2xl font-extrabold dark:text-white" id="seedProfit">ฐ ุชููุงู</div>
</div>

<div class="group bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 border border-gray-200 dark:border-gray-700 rounded-2xl p-5 shadow-sm hover:shadow-xl hover:-translate-y-1 hover:scale-[1.02] transition-all duration-300 relative overflow-hidden">
<div class="absolute top-0 left-0 w-full h-1 bg-orange-500 opacity-70"></div>
<div class="text-sm text-gray-500 mb-2">ุณูุฏ ูพูุงูฺฉุงุฑ ุงุฒ ุณู</div>
<div class="text-2xl font-extrabold dark:text-white" id="poisonProfit">ฐ ุชููุงู</div>
</div>

<div class="group bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 border border-gray-200 dark:border-gray-700 rounded-2xl p-5 shadow-sm hover:shadow-xl hover:-translate-y-1 hover:scale-[1.02] transition-all duration-300 relative overflow-hidden">
<div class="absolute top-0 left-0 w-full h-1 bg-cyan-500 opacity-70"></div>
<div class="text-sm text-gray-500 mb-2">ูุถุนุช ฺฉู ูพูุงูฺฉุงุฑ</div>
<div class="text-2xl font-extrabold dark:text-white" id="contractorStatus">---</div>
</div>

</div>
</main>

</main>



</div>

<footer class="text-center text-sm py-4 bg-white dark:bg-gray-800 mt-auto">
    ุชูุงู ุญููู ูุฒุฏ ุชู ูุงูุฑฺฉุดุช ูุญููุธ ุงุณุช
</footer>

<script>
(function(){
'use strict';

const API_BASE_URL = 'https://edu-api.havirkesht.ir';

function getToken(){
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = '/login/login.html';
        return null;
    }
    return token;
}

function showMessage(elementId, message, isError = true) {
    const element = document.getElementById(elementId);
    element.textContent = message;
    element.style.display = 'block';
    
    if (isError) {
        element.className = 'error-message';
    } else {
        element.className = 'success-message';
    }
    
    setTimeout(() => {
        element.style.display = 'none';
    }, 5000);
}

function formatMoney(num){
    if (num === null || num === undefined) return 'ฐ';
    return new Intl.NumberFormat('fa-IR').format(num);
}

function convertToFarsiNumber(n){
    if (n === null || n === undefined) return 'ฐ';
    const farsiDigits=['ฐ','ฑ','ฒ','ณ','ด','ต','ถ','ท','ธ','น'];
    return n.toString().replace(/\d/g, x => farsiDigits[x]);
}

function formatTonnage(num){
    if (num === null || num === undefined) return 'ฐ';
    const rounded = Math.round(num * 100) / 100;
    return convertToFarsiNumber(rounded.toLocaleString('fa-IR'));
}

async function initDashboard(){
    const token = getToken();
    if (!token) return;
    
    await loadFullReport(token);
}

async function loadFullReport(token){
    try {
        // ุงุณุชูุงุฏู ุงุฒ ุฑูุด GET ุจุง ูพุงุฑุงูุชุฑ ฺฉูุฆุฑ ูุทุงุจู API
        const res = await fetch(`${API_BASE_URL}/report-full/?crop_year_id=13`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'accept': 'application/json'
            }
        });

        if (!res.ok) {
            const errorText = await res.text();
            console.error('ุฎุทุง API:', errorText);
            showMessage('errorMessage', 'ุฎุทุง ุฏุฑ ุฏุฑุงูุช ุงุทูุงุนุงุช ุฏุงุดุจูุฑุฏ', true);
            return;
        }

        const data = await res.json();

        // ุจู ุฑูุฒุฑุณุงู ููุงุฏุฑ
        document.getElementById('contractorBalance').innerText = 
            formatMoney(data.current_contractor_remaining_balance) + ' ุชููุงู';

        document.getElementById('farmerContracts').innerText = 
            convertToFarsiNumber(data.farmers_commitment_count) + ' ุนุฏุฏ';

        document.getElementById('totalTonnage').innerText = 
            formatTonnage(data.total_delivered_tonnage) + ' ุชู';

        document.getElementById('totalDebt').innerText = 
            formatMoney(data.total_farmers_debt) + ' ุชููุงู';

        document.getElementById('totalClaim').innerText = 
            formatMoney(data.total_farmers_receivable) + ' ุชููุงู';

        document.getElementById('remainingToSettle').innerText = 
            formatMoney(data.farmers_remaining_settlement) + ' ุชููุงู';

        document.getElementById('contractorFee').innerText = 
            formatMoney(data.contractor_fee) + ' ุชููุงู';

        document.getElementById('seedProfit').innerText = 
            formatMoney(data.contractor_seed_profit) + ' ุชููุงู';

        document.getElementById('poisonProfit').innerText = 
            formatMoney(data.contractor_pesticide_profit) + ' ุชููุงู';

        // ูุถุนุช ฺฉู
        const statusEl = document.getElementById('contractorStatus');
        const s = data.overall_contractor_status;

        if (s > 0) {
            statusEl.innerText = formatMoney(s) + ' ุชููุงู (+)';
            statusEl.className = 'text-2xl font-extrabold text-green-600';
        } else if (s < 0) {
            statusEl.innerText = formatMoney(Math.abs(s)) + ' ุชููุงู (-)';
            statusEl.className = 'text-2xl font-extrabold text-red-600';
        } else {
            statusEl.innerText = 'ุชุฑุงุฒ ุตูุฑ';
            statusEl.className = 'text-2xl font-extrabold text-yellow-600';
        }

    } catch (err) {
        console.error('ุฎุทุง ุฏุฑ ุฏุฑุงูุช ฺฏุฒุงุฑุด:', err);
        showMessage('errorMessage', 'ุฎุทุง ุฏุฑ ุงุฑุชุจุงุท ุจุง ุณุฑูุฑ', true);
    }
}

// ูุฏุฑุช ุฑูุฏุงุฏูุง ุตูุญู
document.addEventListener('DOMContentLoaded', () => {
    // ูุฏุฑุช ุชู
    const savedTheme = localStorage.getItem('theme') || 'light';
    if (savedTheme === 'dark') {
        document.documentElement.classList.add('dark');
        document.getElementById('themeToggle').textContent = 'โ๏ธ';
    }

    // ูุฏุฑุช ููู
    document.getElementById('menuBtn').onclick = () => {
        document.getElementById('sidebar').classList.toggle('hidden');
    };

    // ูุฏุฑุช ุชู
    document.getElementById('themeToggle').onclick = () => {
        const isDark = document.documentElement.classList.toggle('dark');
        document.getElementById('themeToggle').textContent = isDark ? 'โ๏ธ' : '๐';
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    };

    // ูุฏุฑุช ุฎุฑูุฌ
    document.getElementById('logoutBtn').onclick = (e) => {
        e.preventDefault();
        localStorage.clear();
        window.location.href = '/login/login.html';
    };

    // ุจุงุฑฺฏุฐุงุฑ ุฏุงุดุจูุฑุฏ
    initDashboard();

    // ุจู ุฑูุฒุฑุณุงู ุฎูุฏฺฉุงุฑ ูุฑ 5 ุฏููู
    setInterval(() => {
        const token = getToken();
        if (token) {
            loadFullReport(token);
        }
    }, 300000);
});

// ุชุงุจุน ุนููู ุจุฑุง ุจุงุฒ ู ุจุณุชู ุดุฏู ุฒุฑููููุง
window.toggleSubmenu = function(id) {
    const element = document.getElementById(id);
    if (element) {
        element.classList.toggle('hidden');
    }
};

})();
</script>

</body>
</html>